name: Python CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.13
      uses: actions/setup-python@v5
      with:
        python-version: "3.13"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pylint
        if find . -name 'requirements.txt' | grep -q .; then
          find . -name 'requirements.txt' -exec pip install -r {} \;
        fi
    
    - name: Analyse code with pylint
      run: |
        FILES=$(git ls-files '*.py' | grep -v 'test_')
        if [ -z "$FILES" ]; then
          echo "No Python files found to lint"
          exit 0
        fi
        
        EXIT_CODE=0
        for file in $FILES; do
          echo "Linting $file..."
          pylint "$file" --fail-under=8.0 --output-format=colorized || EXIT_CODE=$?
        done
        
        exit $EXIT_CODE

  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.13
      uses: actions/setup-python@v5
      with:
        python-version: "3.13"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov
        if find . -name 'requirements.txt' | grep -q .; then
          find . -name 'requirements.txt' -exec pip install -r {} \;
        fi
    
    - name: Set PYTHONPATH
      run: echo "PYTHONPATH=${{ github.workspace }}" >> $GITHUB_ENV
    
    - name: Run tests with coverage
      run: |
        # Find all non-test Python files
        SOURCE_FILES=$(git ls-files '*.py' | grep -v 'test_')
        
        if [ -z "$SOURCE_FILES" ]; then
          echo "No source files found"
          exit 0
        fi
        
        EXIT_CODE=0
        for source_file in $SOURCE_FILES; do
          # Find corresponding test file
          dir=$(dirname "$source_file")
          base=$(basename "$source_file" .py)
          test_file="${dir}/test_${base}.py"
          
          if [ -f "$test_file" ]; then
            echo "Testing $source_file with $test_file..."
            pytest "$test_file" --cov="$source_file" --cov-report=term-missing || EXIT_CODE=$?
          else
            echo "No test file found for $source_file (expected: $test_file)"
          fi
        done
        
        exit $EXIT_CODE